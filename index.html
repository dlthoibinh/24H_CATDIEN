<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>24h CẮT ĐIỆN</title>

  <!-- Manifest & PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="apple-touch-icon" href="evn_logo.png">
  <link rel="canonical" href="https://dlthoibinh.github.io/24H_CATDIEN/">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          frame-src https://script.google.com https://*.googleusercontent.com;
          connect-src 'self' https://script.google.com https://*.googleusercontent.com;
          img-src 'self' data: https:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline';
          base-uri 'self';
          form-action 'none';
          block-all-mixed-content;
        ">

  <link rel="preconnect" href="https://script.google.com">
  <link rel="preconnect" href="https://script.googleusercontent.com">

  <style>
    html,body{height:100%;margin:0;background:#f6f7fb;font-family:system-ui,Roboto,Arial}
    .app{position:fixed;inset:0;display:flex;flex-direction:column}
    #wrap{flex:1;position:relative;background:#f6f7fb}
    iframe{position:absolute;inset:0;border:0;width:100%;height:100%;background:#fff}

    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:#ffffff}
    .overlay.show{display:flex}
    .card{width:min(560px,92vw);border:1px solid #e5e7eb;border-radius:16px;padding:14px;background:#fff;box-shadow:0 12px 30px rgba(0,0,0,.08)}
    .row{display:flex;gap:12px;align-items:center}
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#0ea5e9;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status{font-weight:800}
    .hint{margin-top:6px;color:#6b7280;font-size:13px;line-height:1.35}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800;cursor:pointer}
    button.primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}

    .offline{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:#fff}
    .offline.show{display:flex}
  </style>
</head>

<body>
  <div class="app">
    <div id="wrap">

      <iframe id="app"
        src="about:blank"
        loading="eager"
        referrerpolicy="no-referrer"
        allow="geolocation *; fullscreen *; camera *; microphone *; clipboard-read; clipboard-write; accelerometer; gyroscope; magnetometer; storage-access-by-user-activation *">
      </iframe>

      <div id="overlay" class="overlay show">
        <div class="card">
          <div class="row">
            <div class="spinner"></div>
            <div>
              <div id="status" class="status">Đang tải ứng dụng…</div>
              <div id="hint" class="hint">Nếu treo lâu, bấm Tải lại hoặc Mở trực tiếp.</div>
            </div>
          </div>
          <div class="actions">
            <button id="btnReload" class="primary">Tải lại</button>
            <button id="btnDirect">Mở trực tiếp</button>
          </div>
        </div>
      </div>

      <div id="offline" class="offline">
        <div style="text-align:center">
          <h2>Không có mạng</h2>
          <p>Ứng dụng cần kết nối Internet để chạy.</p>
          <button onclick="location.reload()">Thử lại</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ==== CONFIG (đổi đúng 1 chỗ này nếu anh đổi link GAS) ====
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxXRbDDCz6J21IRJeskHvVtIuKtofn7ZTM8Y0ndw62drizcpAgwGn1TGQplfkx929Rg/exec";

    // thời gian chờ trước khi coi là “trắng/treo”
    const WATCHDOG_MS = 15000;

    // quá thời gian này thì tự chuyển sang mở trực tiếp (top-level) để né chặn session trong iframe
    const AUTO_DIRECT_MS = 22000;

    // ==== BASE (GitHub Pages subfolder safe) ====
    const BASE = (location.pathname.endsWith("/")
      ? location.pathname
      : location.pathname.replace(/\/[^/]*$/, "/"));

    // ==== UI refs ====
    const iframe  = document.getElementById("app");
    const overlay = document.getElementById("overlay");
    const statusEl= document.getElementById("status");
    const hintEl  = document.getElementById("hint");

    const setOfflineUI = (on) => document.getElementById("offline").classList.toggle("show", !!on);
    addEventListener("online",  () => setOfflineUI(false));
    addEventListener("offline", () => setOfflineUI(true));
    setOfflineUI(!navigator.onLine);

    function showOverlay(text, hint){
      statusEl.textContent = text || "Đang tải ứng dụng…";
      hintEl.textContent   = hint || "Nếu treo lâu, bấm Tải lại hoặc Mở trực tiếp.";
      overlay.classList.add("show");
    }
    function hideOverlay(){ overlay.classList.remove("show"); }

    function openDirect(){
      // top-level mở trực tiếp GAS: ổn định nhất khi iframe bị chặn cookie/session
      const u = new URL(GAS_URL);
      u.searchParams.set("source", "pwa");
      u.searchParams.set("_ts", String(Date.now()));
      location.replace(u.toString());
    }

    // ==== LOAD + WATCHDOG ====
    let ready = false;
    let tries = 0;
    let tWatch = null;
    let tAuto  = null;

    function clearTimers(){
      if (tWatch) clearTimeout(tWatch);
      if (tAuto)  clearTimeout(tAuto);
      tWatch = null; tAuto = null;
    }

    function loadIframe(reason){
      tries += 1;
      ready = false;
      clearTimers();

      showOverlay(
        `Đang tải ứng dụng… (lần ${tries})`,
        "Nếu treo lâu, bấm Tải lại hoặc Mở trực tiếp."
      );

      const u = new URL(GAS_URL);
      u.searchParams.set("source", "pwa");
      u.searchParams.set("_ts", String(Date.now()));

      // ép iOS/PWA refresh iframe: about:blank trước
      iframe.src = "about:blank";
      requestAnimationFrame(() => { iframe.src = u.toString(); });

      // watchdog: quá WATCHDOG_MS mà chưa ready => báo trắng và cho nút xử lý
      tWatch = setTimeout(() => {
        if (ready) return;
        showOverlay(
          "Có thể bị màn hình trắng/treo khi chạy trong iframe",
          "Bấm Mở trực tiếp để vào ngay (ổn định nhất). Hoặc bấm Tải lại."
        );
      }, WATCHDOG_MS);

      // auto-direct: quá AUTO_DIRECT_MS mà vẫn chưa ready => tự chuyển sang mở trực tiếp
      tAuto = setTimeout(() => {
        if (!ready) openDirect();
      }, AUTO_DIRECT_MS);
    }

    // Nếu anh chèn postMessage GAS_READY trong Apps Script thì wrapper sẽ nhận được và tắt overlay đúng lúc
    addEventListener("message", (ev) => {
      if (ev.origin !== "https://script.google.com" && ev.origin !== "https://script.googleusercontent.com") return;
      const data = ev.data || {};
      if (data && data.type === "GAS_READY") {
        ready = true;
        clearTimers();
        hideOverlay();
      }
    });

    // fallback: iframe load xong thì cho qua sau 3s để khỏi kẹt overlay (nếu không có GAS_READY)
    iframe.addEventListener("load", () => {
      setTimeout(() => {
        if (!ready) {
          ready = true;
          clearTimers();
          hideOverlay();
        }
      }, 3000);
    });

    document.getElementById("btnReload").addEventListener("click", () => loadIframe("manual"));
    document.getElementById("btnDirect").addEventListener("click", () => openDirect());

    // ==== SERVICE WORKER (auto cập nhật) ====
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register(BASE + "sw.js", { scope: BASE })
        .then((reg) => {
          // nếu SW đổi controller => reload để tránh trắng do file mới/cũ lẫn nhau
          navigator.serviceWorker.addEventListener("controllerchange", () => {
            location.reload();
          });

          // nếu có bản mới chờ => kích hoạt luôn
          if (reg.waiting) reg.waiting.postMessage("SKIP_WAITING");

          reg.addEventListener("updatefound", () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener("statechange", () => {
              if (sw.state === "installed" && reg.waiting) {
                reg.waiting.postMessage("SKIP_WAITING");
              }
            });
          });
        })
        .catch((e) => console.warn("SW register failed:", e));
    }

    // START
    loadIframe("boot");
  </script>
</body>
</html>
