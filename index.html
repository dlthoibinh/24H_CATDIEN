<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>24h CẮT ĐIỆN</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="apple-touch-icon" href="evn_logo.png">
  <link rel="canonical" href="https://dlthoibinh.github.io/24H_CATDIEN/">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- CSP (giữ chặt, nhưng cho đúng domain Apps Script hay redirect) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          frame-src https://script.google.com https://script.googleusercontent.com https://*.googleusercontent.com;
          connect-src 'self' https://script.google.com https://script.googleusercontent.com https://*.googleusercontent.com;
          img-src 'self' data: https:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline';
          base-uri 'self';
          form-action 'none';
          block-all-mixed-content;
        ">

  <style>
    html,body{height:100%;margin:0;background:#f6f7fb;font-family:system-ui,Roboto,Arial}
    .app{position:fixed;inset:0;display:flex;flex-direction:column}
    #wrap{flex:1;position:relative}

    iframe{position:absolute;inset:0;border:0;width:100%;height:100%;background:#fff}

    .layer{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:linear-gradient(180deg,#f6f7fb,#ffffff);
      padding:16px;
    }
    .layer.show{display:flex}

    .card{
      width:min(520px, 94vw);
      background:#fff;border-radius:18px;
      box-shadow:0 12px 30px rgba(0,0,0,.12);
      padding:16px 16px 14px;
      text-align:center;
    }
    .title{font-weight:900;font-size:18px;margin:6px 0 8px}
    .muted{color:#555;font-size:14px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .btn{
      appearance:none;border:1px solid #e5e7eb;background:#fff;color:#111;
      padding:10px 12px;border-radius:999px;font-weight:800;cursor:pointer;
      min-width:140px;
    }
    .btn.primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .btn.danger{background:#fff;color:#b91c1c;border-color:#fecaca}

    .spin{
      width:28px;height:28px;border:3px solid #0ea5e9;border-top-color:transparent;
      border-radius:50%;animation:rot .7s linear infinite;margin:0 auto 10px;
    }
    @keyframes rot{to{transform:rotate(360deg)}}

    .badge{
      display:inline-block;margin-top:8px;
      font-size:12px;color:#0f172a;background:#e0f2fe;border:1px solid #bae6fd;
      padding:4px 8px;border-radius:999px;font-weight:800;
    }

    .offline{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:#fff;
    }
    .offline.show{display:flex}
  </style>
</head>

<body>
  <div class="app">
    <div id="wrap">

      <iframe id="appFrame"
        src="about:blank"
        allow="geolocation *; fullscreen *; camera *; microphone *; clipboard-read; clipboard-write; accelerometer; gyroscope; magnetometer"
        referrerpolicy="no-referrer"
        loading="eager"></iframe>

      <!-- Loading -->
      <div id="loading" class="layer show">
        <div class="card">
          <div class="spin"></div>
          <div class="title">Đang mở 24h Cắt Điện…</div>
          <div class="muted">Nếu máy chặn iframe/cookie cross-site, đôi lúc sẽ trắng màn hình. Đợi 10–12 giây, hệ thống sẽ tự hiện nút xử lý.</div>
          <div class="badge" id="verBadge">v…</div>
        </div>
      </div>

      <!-- Error / Fallback -->
      <div id="fallback" class="layer">
        <div class="card">
          <div class="title">Không tải được nội dung</div>
          <div class="muted" id="fbMsg">
            Iframe chưa load xong hoặc bị chặn trên thiết bị này.
            Anh bấm “Mở trực tiếp” là chắc chắn vào được.
          </div>
          <div class="row">
            <button class="btn primary" id="btnReload">Tải lại</button>
            <button class="btn" id="btnDirect">Mở trực tiếp</button>
            <button class="btn danger" id="btnClear">Xóa cache</button>
          </div>
          <div class="muted" style="margin-top:10px">
            Tip: sau khi “Xóa cache”, anh đóng app PWA và mở lại 1 lần.
          </div>
        </div>
      </div>

      <!-- Offline -->
      <div id="offline" class="offline">
        <div class="card">
          <div class="title">Không có mạng</div>
          <div class="muted">Ứng dụng cần Internet để chạy.</div>
          <div class="row">
            <button class="btn primary" onclick="location.reload()">Thử lại</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const APP_VER = '2025.12.12.1'; // đổi số này mỗi lần anh update để dễ “ép” refresh
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxXRbDDCz6J21IRJeskHvVtIuKtofn7ZTM8Y0ndw62drizcpAgwGn1TGQplfkx929Rg/exec';

    // ====== BASE (GitHub Pages) ======
    const BASE = (location.pathname.endsWith('/')
      ? location.pathname
      : location.pathname.replace(/\/[^/]*$/, '/'));

    // UI helpers
    const $loading = document.getElementById('loading');
    const $fallback = document.getElementById('fallback');
    const $offline = document.getElementById('offline');
    const $frame = document.getElementById('appFrame');
    const $ver = document.getElementById('verBadge');
    $ver.textContent = 'v' + APP_VER;

    const setOfflineUI = on => $offline.classList.toggle('show', !!on);
    addEventListener('online',  ()=>setOfflineUI(false));
    addEventListener('offline', ()=>setOfflineUI(true));
    setOfflineUI(!navigator.onLine);

    function showLoading(){
      $loading.classList.add('show');
      $fallback.classList.remove('show');
    }
    function showFallback(msg){
      if (msg) document.getElementById('fbMsg').textContent = msg;
      $loading.classList.remove('show');
      $fallback.classList.add('show');
    }
    function hideAllOverlays(){
      $loading.classList.remove('show');
      $fallback.classList.remove('show');
    }

    function loadFrame(hard){
      showLoading();
      const url = new URL(GAS_URL);
      url.searchParams.set('source', 'pwa');
      url.searchParams.set('v', APP_VER);
      if (hard) url.searchParams.set('_', String(Date.now())); // bust session edge-case
      $frame.src = url.toString();
    }

    // iframe load watchdog
    let loaded = false;
    let watchdog = null;

    function armWatchdog(){
      clearTimeout(watchdog);
      loaded = false;
      watchdog = setTimeout(() => {
        if (!loaded && navigator.onLine) {
          showFallback('Iframe chưa load sau 12 giây. Thường do thiết bị chặn iframe/cookie cross-site hoặc cache kẹt.');
        }
      }, 12000);
    }

    $frame.addEventListener('load', () => {
      loaded = true;
      clearTimeout(watchdog);
      hideAllOverlays();
    });

    // Nếu quay lại từ nền (iOS/Android hay bị trắng), thử load lại nếu chưa load
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !loaded && navigator.onLine) {
        armWatchdog();
        loadFrame(true);
      }
    });
    window.addEventListener('pageshow', (e) => {
      if (e.persisted && navigator.onLine) {
        armWatchdog();
        loadFrame(true);
      }
    });

    // Buttons
    document.getElementById('btnReload').addEventListener('click', () => {
      armWatchdog();
      loadFrame(true);
    });
    document.getElementById('btnDirect').addEventListener('click', () => {
      // mở trực tiếp (chắc chắn vào được)
      location.href = GAS_URL;
    });
    document.getElementById('btnClear').addEventListener('click', async () => {
      try {
        showLoading();

        // 1) Clear caches
        if (window.caches) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }

        // 2) Unregister SW
        if (navigator.serviceWorker) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }

        // 3) Clear storage (best effort)
        try { localStorage.clear(); } catch(_){}
        try { sessionStorage.clear(); } catch(_){}

        // Reload fresh
        location.replace(location.pathname + '?source=pwa&v=' + encodeURIComponent(APP_VER) + '&_=' + Date.now());
      } catch (e) {
        showFallback('Xóa cache không thành công: ' + (e && e.message ? e.message : e));
      }
    });

    // Register SW (không auto-reload để tránh loop)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(BASE + 'sw.js', { scope: BASE })
        .then(r => console.log('SW registered:', r.scope))
        .catch(e => console.warn('SW register failed:', e));
    }

    // START
    armWatchdog();
    loadFrame(false);
  </script>
</body>
</html>
